<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Adjudicaci√≥n - MINSA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #dc3545 0%, #003d82 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #003d82 0%, #001f3f 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            border-bottom: 4px solid #dc3545;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header-buttons {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            gap: 10px;
        }

        .mode-toggle {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid white;
        }

        .mode-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .mode-toggle span {
            font-weight: 600;
            font-size: 0.9em;
        }

        .btn-dashboard {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid white;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .btn-dashboard:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .mode-indicator {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            padding: 15px 30px;
            text-align: center;
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            border-top: 4px solid #003d82;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #003d82;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .content {
            padding: 30px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #003d82;
        }

        .form-section h2 {
            color: #003d82;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .moderator-only {
            border: 3px solid #dc3545;
            position: relative;
        }

        .moderator-badge {
            position: absolute;
            top: -15px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        input, select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #003d82;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #003d82 0%, #001f3f 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 61, 130, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #003d82 0%, #001f3f 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-disponible {
            background: #28a745;
            color: white;
        }

        .badge-adjudicada {
            background: #dc3545;
            color: white;
        }

        .badge-region {
            background: #003d82;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-info {
            background: #cfe2ff;
            color: #084298;
            border-left: 4px solid #003d82;
        }

        .hidden {
            display: none;
        }

        /* Dashboard Styles */
        .dashboard-container {
            padding: 30px;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h2 {
            color: #003d82;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .dashboard-header p {
            color: #666;
            font-size: 1.1em;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #003d82;
        }

        .chart-card h3 {
            color: #003d82;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .chart-bar {
            margin-bottom: 20px;
        }

        .chart-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .chart-bar-bg {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #003d82 0%, #001f3f 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
        }

        .chart-bar-fill.disponibles {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .chart-bar-fill.adjudicadas {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #003d82 0%, #001f3f 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .summary-card.green {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .summary-card.red {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .summary-card.blue {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        }

        .summary-card h4 {
            font-size: 1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .detail-table {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #003d82;
        }

        .detail-table h3 {
            color: #003d82;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row:hover {
            background: #f8f9fa;
        }

        .detail-info {
            flex: 1;
        }

        .detail-name {
            font-weight: 600;
            color: #003d82;
            margin-bottom: 5px;
        }

        .detail-meta {
            font-size: 0.9em;
            color: #666;
        }

        .detail-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .detail-stat {
            text-align: center;
        }

        .detail-stat-number {
            font-size: 1.5em;
            font-weight: bold;
        }

        .detail-stat-label {
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-buttons">
                <button class="btn-dashboard" onclick="toggleView()">
                    <span id="viewButtonText">üìä Ver Dashboard</span>
                </button>
                <div class="mode-toggle" onclick="toggleMode()">
                    <span id="modeText">üõ°Ô∏è Modo Moderador</span>
                </div>
            </div>
            <h1>üè• Sistema de Adjudicaci√≥n de Plazas</h1>
            <p>Ministerio de Salud - Regi√≥n Ica</p>
        </div>

        <div class="mode-indicator" id="modeIndicator">
            üõ°Ô∏è MODO MODERADOR ACTIVO - Puede cargar y gestionar plazas
        </div>

        <!-- Vista Principal -->
        <div id="mainView">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalPlazas">0</div>
                    <div class="stat-label">Total de Plazas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="plazasDisponibles">0</div>
                    <div class="stat-label">Plazas Disponibles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="plazasAdjudicadas">0</div>
                    <div class="stat-label">Plazas Adjudicadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="porcentajeOcupacion">0%</div>
                    <div class="stat-label">Ocupaci√≥n</div>
                </div>
            </div>

            <!-- Secci√≥n de Moderador -->
            <div class="content">
                <div id="moderatorSection" class="form-section moderator-only">
                    <span class="moderator-badge">üõ°Ô∏è SOLO MODERADORES</span>
                    <h2>üìã Cargar Plazas de Ica</h2>
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è En modo moderador puedes registrar nuevas plazas. Todas las plazas son exclusivas de la regi√≥n Ica.
                    </div>
                    <form id="plazaForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>C√≥digo de Plaza</label>
                                <input type="text" id="codigoPlaza" placeholder="Ej: ICA-2024-001" required>
                            </div>
                            <div class="form-group">
                                <label>Cargo</label>
                                <select id="cargo" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Enfermer√≠a">Enfermer√≠a</option>
                                    <option value="Obstetricia">Obstetricia</option>
                                    <option value="Psicolog√≠a">Psicolog√≠a</option>
                                    <option value="Medicina Humana">Medicina Humana</option>
                                    <option value="Tecnolog√≠a M√©dica">Tecnolog√≠a M√©dica</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Establecimiento</label>
                                <select id="establecimiento" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Hospital Regional de Ica">Hospital Regional de Ica</option>
                                    <option value="Hospital de Apoyo de Nazca">Hospital de Apoyo de Nazca</option>
                                    <option value="Hospital Santa Mar√≠a del Socorro">Hospital Santa Mar√≠a del Socorro</option>
                                    <option value="Hospital San Jos√© de Chincha">Hospital San Jos√© de Chincha</option>
                                    <option value="Centro de Salud Guadalupe">Centro de Salud Guadalupe</option>
                                    <option value="Centro de Salud Parcona">Centro de Salud Parcona</option>
                                    <option value="Centro de Salud San Juan Bautista">Centro de Salud San Juan Bautista</option>
                                    <option value="Centro de Salud La Tingui√±a">Centro de Salud La Tingui√±a</option>
                                    <option value="Puesto de Salud Ocucaje">Puesto de Salud Ocucaje</option>
                                    <option value="Puesto de Salud Los Aquijes">Puesto de Salud Los Aquijes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Provincia</label>
                                <select id="provincia" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Ica">Ica</option>
                                    <option value="Chincha">Chincha</option>
                                    <option value="Pisco">Pisco</option>
                                    <option value="Nazca">Nazca</option>
                                    <option value="Palpa">Palpa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cantidad de Vacantes</label>
                                <input type="number" id="cantidad" min="1" max="50" value="1" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">‚ûï Agregar Plaza</button>
                    </form>
                </div>

                <!-- Secci√≥n para Adjudicar -->
                <div class="form-section">
                    <h2>üë§ Adjudicar Plaza</h2>
                    <form id="adjudicacionForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>C√≥digo de Plaza</label>
                                <select id="plazaSelect" required>
                                    <option value="">Seleccionar plaza disponible...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Nombre del Profesional</label>
                                <input type="text" id="nombreProfesional" placeholder="Nombres completos" required>
                            </div>
                            <div class="form-group">
                                <label>DNI</label>
                                <input type="text" id="dni" pattern="[0-9]{8}" maxlength="8" placeholder="8 d√≠gitos" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">‚úÖ Adjudicar Plaza</button>
                    </form>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Cargo</th>
                                <th>Establecimiento</th>
                                <th>Provincia</th>
                                <th>Vacantes</th>
                                <th>Disponibles</th>
                                <th>Estado</th>
                                <th>Profesional</th>
                                <th>DNI</th>
                                <th id="accionesHeader">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablePlazas">
                            <tr>
                                <td colspan="10" class="empty-state">
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M9 11l3 3L22 4"></path>
                                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                                        </svg>
                                        <h3>No hay plazas registradas</h3>
                                        <p>Activa el modo moderador para cargar plazas</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vista Dashboard -->
        <div id="dashboardView" class="hidden">
            <div class="dashboard-container">
                <div class="dashboard-header">
                    <h2>üìä Dashboard de Plazas MINSA Ica</h2>
                    <p>An√°lisis detallado de vacantes y adjudicaciones</p>
                </div>

                <div class="summary-cards">
                    <div class="summary-card">
                        <h4>Total de Vacantes</h4>
                        <div class="number" id="dashTotalPlazas">0</div>
                        <p>Plazas registradas</p>
                    </div>
                    <div class="summary-card green">
                        <h4>Vacantes Disponibles</h4>
                        <div class="number" id="dashPlazasDisponibles">0</div>
                        <p>Listas para adjudicar</p>
                    </div>
                    <div class="summary-card red">
                        <h4>Vacantes Adjudicadas</h4>
                        <div class="number" id="dashPlazasAdjudicadas">0</div>
                        <p>Profesionales asignados</p>
                    </div>
                    <div class="summary-card blue">
                        <h4>Tasa de Ocupaci√≥n</h4>
                        <div class="number" id="dashPorcentaje">0%</div>
                        <p>Porcentaje ocupado</p>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>üó∫Ô∏è Distribuci√≥n por Provincia</h3>
                        <div id="chartProvincias"></div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>üëî Distribuci√≥n por Cargo</h3>
                        <div id="chartCargos"></div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>üìà Estado de Ocupaci√≥n</h3>
                        <div id="chartEstado"></div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>üè• Top Establecimientos</h3>
                        <div id="chartEstablecimientos"></div>
                    </div>
                </div>

                <div class="detail-table">
                    <h3>üìã Detalle por Plaza</h3>
                    <div id="detallePlazas"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let plazas = [];
        let isModerator = true;
        let isDashboardView = false;

        function toggleView() {
            isDashboardView = !isDashboardView;
            const mainView = document.getElementById('mainView');
            const dashboardView = document.getElementById('dashboardView');
            const viewButton = document.getElementById('viewButtonText');
            
            if (isDashboardView) {
                mainView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                viewButton.textContent = 'üìã Ver Plazas';
                renderDashboard();
            } else {
                mainView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                viewButton.textContent = 'üìä Ver Dashboard';
            }
        }

        function renderDashboard() {
            const total = plazas.reduce((sum, p) => sum + p.cantidadTotal, 0);
            const adjudicadas = plazas.reduce((sum, p) => sum + p.adjudicaciones.length, 0);
            const disponibles = total - adjudicadas;
            const porcentaje = total > 0 ? Math.round((adjudicadas / total) * 100) : 0;

            document.getElementById('dashTotalPlazas').textContent = total;
            document.getElementById('dashPlazasDisponibles').textContent = disponibles;
            document.getElementById('dashPlazasAdjudicadas').textContent = adjudicadas;
            document.getElementById('dashPorcentaje').textContent = porcentaje + '%';

            renderChartProvincias();
            renderChartCargos();
            renderChartEstado();
            renderChartEstablecimientos();
            renderDetallePlazas();
        }

        function renderChartProvincias() {
            const provincias = {};
            plazas.forEach(p => {
                if (!provincias[p.provincia]) {
                    provincias[p.provincia] = { total: 0, adjudicadas: 0 };
                }
                provincias[p.provincia].total += p.cantidadTotal;
                provincias[p.provincia].adjudicadas += p.adjudicaciones.length;
            });

            let html = '';
            Object.entries(provincias).forEach(([provincia, data]) => {
                const disponibles = data.total - data.adjudicadas;
                const porcentaje = data.total > 0 ? (data.adjudicadas / data.total * 100) : 0;
                html += `
                    <div class="chart-bar">
                        <div class="chart-bar-label">
                            <span>${provincia}</span>
                            <span>${data.adjudicadas}/${data.total}</span>
                        </div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${porcentaje}%">
                                ${porcentaje.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('chartProvincias').innerHTML = html || '<p style="text-align: center; color: #999;">No hay datos</p>';
        }

        function renderChartCargos() {
            const cargos = {};
            plazas.forEach(p => {
                if (!cargos[p.cargo]) {
                    cargos[p.cargo] = { total: 0, adjudicadas: 0 };
                }
                cargos[p.cargo].total += p.cantidadTotal;
                cargos[p.cargo].adjudicadas += p.adjudicaciones.length;
            });

            let html = '';
            Object.entries(cargos).sort((a, b) => b[1].total - a[1].total).slice(0, 5).forEach(([cargo, data]) => {
                const porcentaje = data.total > 0 ? (data.adjudicadas / data.total * 100) : 0;
                html += `
                    <div class="chart-bar">
                        <div class="chart-bar-label">
                            <span>${cargo}</span>
                            <span>${data.adjudicadas}/${data.total}</span>
                        </div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${porcentaje}%">
                                ${porcentaje.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('chartCargos').innerHTML = html || '<p style="text-align: center; color: #999;">No hay datos</p>';
        }

        function renderChartEstado() {
            const total = plazas.reduce((sum, p) => sum + p.cantidadTotal, 0);
            const adjudicadas = plazas.reduce((sum, p) => sum + p.adjudicaciones.length, 0);
            const disponibles = total - adjudicadas;
            
            const porcentajeDisp = total > 0 ? (disponibles / total * 100) : 0;
            const porcentajeAdj = total > 0 ? (adjudicadas / total * 100) : 0;

            const html = `
                <div class="chart-bar">
                    <div class="chart-bar-label">
                        <span>Disponibles</span>
                        <span>${disponibles}</span>
                    </div>
                    <div class="chart-bar-bg">
                        <div class="chart-bar-fill disponibles" style="width: ${porcentajeDisp}%">
                            ${porcentajeDisp.toFixed(0)}%
                        </div>
                    </div>
                </div>
                <div class="chart-bar">
                    <div class="chart
-bar-label">
                        <span>Adjudicadas</span>
                        <span>${adjudicadas}</span>
                    </div>
                    <div class="chart-bar-bg">
                        <div class="chart-bar-fill adjudicadas" style="width: ${porcentajeAdj}%">
                            ${porcentajeAdj.toFixed(0)}%
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('chartEstado').innerHTML = html;
        }

        function renderChartEstablecimientos() {
            const establecimientos = {};
            plazas.forEach(p => {
                if (!establecimientos[p.establecimiento]) {
                    establecimientos[p.establecimiento] = { total: 0, adjudicadas: 0 };
                }
                establecimientos[p.establecimiento].total += p.cantidadTotal;
                establecimientos[p.establecimiento].adjudicadas += p.adjudicaciones.length;
            });

            let html = '';
            Object.entries(establecimientos).sort((a, b) => b[1].total - a[1].total).slice(0, 5).forEach(([establecimiento, data]) => {
                const porcentaje = data.total > 0 ? (data.adjudicadas / data.total * 100) : 0;
                html += `
                    <div class="chart-bar">
                        <div class="chart-bar-label">
                            <span style="font-size: 0.85em;">${establecimiento}</span>
                            <span>${data.adjudicadas}/${data.total}</span>
                        </div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${porcentaje}%">
                                ${porcentaje.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('chartEstablecimientos').innerHTML = html || '<p style="text-align: center; color: #999;">No hay datos</p>';
        }

        function renderDetallePlazas() {
            let html = '';
            plazas.forEach(plaza => {
                const disponibles = plaza.cantidadTotal - plaza.adjudicaciones.length;
                html += `
                    <div class="detail-row">
                        <div class="detail-info">
                            <div class="detail-name">${plaza.codigo} - ${plaza.cargo}</div>
                            <div class="detail-meta">${plaza.establecimiento} ‚Ä¢ ${plaza.provincia}</div>
                        </div>
                        <div class="detail-stats">
                            <div class="detail-stat">
                                <div class="detail-stat-number" style="color: #003d82;">${plaza.cantidadTotal}</div>
                                <div class="detail-stat-label">Total</div>
                            </div>
                            <div class="detail-stat">
                                <div class="detail-stat-number" style="color: #28a745;">${disponibles}</div>
                                <div class="detail-stat-label">Disponibles</div>
                            </div>
                            <div class="detail-stat">
                                <div class="detail-stat-number" style="color: #dc3545;">${plaza.adjudicaciones.length}</div>
                                <div class="detail-stat-label">Adjudicadas</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('detallePlazas').innerHTML = html || '<p style="text-align: center; color: #999; padding: 20px;">No hay plazas registradas</p>';
        }

        function toggleMode() {
            isModerator = !isModerator;
            const modeText = document.getElementById('modeText');
            const modeIndicator = document.getElementById('modeIndicator');
            const moderatorSection = document.getElementById('moderatorSection');
            
            if (isModerator) {
                modeText.textContent = 'üõ°Ô∏è Modo Moderador';
                modeIndicator.textContent = 'üõ°Ô∏è MODO MODERADOR ACTIVO - Puede cargar y gestionar plazas';
                modeIndicator.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                moderatorSection.classList.remove('hidden');
            } else {
                modeText.textContent = 'üë§ Modo Usuario';
                modeIndicator.textContent = 'üë§ MODO USUARIO - Solo puede adjudicar plazas';
                modeIndicator.style.background = 'linear-gradient(135deg, #003d82 0%, #001f3f 100%)';
                moderatorSection.classList.add('hidden');
            }
            
            renderizarTabla();
        }

        function actualizarEstadisticas() {
            const total = plazas.reduce((sum, p) => sum + p.cantidadTotal, 0);
            const adjudicadas = plazas.reduce((sum, p) => sum + p.adjudicaciones.length, 0);
            const disponibles = total - adjudicadas;
            const porcentaje = total > 0 ? Math.round((adjudicadas / total) * 100) : 0;

            document.getElementById('totalPlazas').textContent = total;
            document.getElementById('plazasDisponibles').textContent = disponibles;
            document.getElementById('plazasAdjudicadas').textContent = adjudicadas;
            document.getElementById('porcentajeOcupacion').textContent = porcentaje + '%';
        }

        function actualizarSelectPlazas() {
            const select = document.getElementById('plazaSelect');
            select.innerHTML = '<option value="">Seleccionar plaza disponible...</option>';
            
            plazas.filter(p => p.cantidadTotal > p.adjudicaciones.length).forEach(plaza => {
                const disponibles = plaza.cantidadTotal - plaza.adjudicaciones.length;
                const option = document.createElement('option');
                option.value = plaza.codigo;
                option.textContent = `${plaza.codigo} - ${plaza.cargo} - ${plaza.establecimiento} (${disponibles} disponibles)`;
                select.appendChild(option);
            });
        }

        function renderizarTabla() {
            const tbody = document.getElementById('tablePlazas');
            
            if (plazas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 11l3 3L22 4"></path>
                                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                                </svg>
                                <h3>No hay plazas registradas</h3>
                                <p>Activa el modo moderador para cargar plazas</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            plazas.forEach((plaza, indexPlaza) => {
                const disponibles = plaza.cantidadTotal - plaza.adjudicaciones.length;
                const totalmenteOcupada = disponibles === 0;
                
                // Fila principal de la plaza
                html += `
                    <tr style="background: ${totalmenteOcupada ? '#ffe6e6' : 'white'};">
                        <td rowspan="${plaza.adjudicaciones.length + 1}"><strong>${plaza.codigo}</strong></td>
                        <td rowspan="${plaza.adjudicaciones.length + 1}">${plaza.cargo}</td>
                        <td rowspan="${plaza.adjudicaciones.length + 1}">${plaza.establecimiento}</td>
                        <td rowspan="${plaza.adjudicaciones.length + 1}"><span class="badge badge-region">${plaza.provincia}</span></td>
                        <td rowspan="${plaza.adjudicaciones.length + 1}"><strong style="font-size: 1.2em; color: #003d82;">${plaza.cantidadTotal}</strong></td>
                        <td rowspan="${plaza.adjudicaciones.length + 1}">
                            <strong style="font-size: 1.2em; color: ${disponibles > 0 ? '#28a745' : '#dc3545'};">
                                ${disponibles}
                            </strong>
                        </td>
                        <td rowspan="${plaza.adjudicaciones.length + 1}">
                            <span class="badge ${totalmenteOcupada ? 'badge-adjudicada' : 'badge-disponible'}">
                                ${totalmenteOcupada ? 'Completa' : disponibles + ' Disponible' + (disponibles !== 1 ? 's' : '')}
                            </span>
                        </td>
                        <td colspan="2" style="text-align: center; color: #999; font-style: italic;">
                            ${plaza.adjudicaciones.length === 0 ? 'Sin adjudicaciones' : 'Ver adjudicaciones ‚Üì'}
                        </td>
                        <td rowspan="${plaza.adjudicaciones.length + 1}">
                            ${isModerator ? `
                                <button class="btn btn-danger" onclick="eliminarPlaza(${indexPlaza})" style="padding: 8px 16px; font-size: 0.9em;">
                                    üóëÔ∏è Eliminar
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
                
                // Filas de adjudicaciones
                plaza.adjudicaciones.forEach((adj, indexAdj) => {
                    html += `
                        <tr style="background: #f8f9fa;">
                            <td>${adj.profesional}</td>
                            <td>${adj.dni}</td>
                        </tr>
                    `;
                });
            });
            
            tbody.innerHTML = html;
        }

        document.getElementById('plazaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!isModerator) {
                alert('Debes estar en modo moderador para agregar plazas');
                return;
            }
            
            const plaza = {
                codigo: document.getElementById('codigoPlaza').value,
                cargo: document.getElementById('cargo').value,
                establecimiento: document.getElementById('establecimiento').value,
                provincia: document.getElementById('provincia').value,
                cantidadTotal: parseInt(document.getElementById('cantidad').value),
                region: 'Ica',
                adjudicaciones: []
            };

            plazas.push(plaza);
            this.reset();
            document.getElementById('cantidad').value = 1;
            
            actualizarEstadisticas();
            actualizarSelectPlazas();
            renderizarTabla();
            
            alert('‚úÖ Plaza agregada exitosamente');
        });

        document.getElementById('adjudicacionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const codigoPlaza = document.getElementById('plazaSelect').value;
            const plaza = plazas.find(p => p.codigo === codigoPlaza);
            
            if (plaza) {
                const disponibles = plaza.cantidadTotal - plaza.adjudicaciones.length;
                
                if (disponibles <= 0) {
                    alert('‚ö†Ô∏è Esta plaza ya no tiene vacantes disponibles');
                    return;
                }
                
                const adjudicacion = {
                    profesional: document.getElementById('nombreProfesional').value,
                    dni: document.getElementById('dni').value
                };
                
                plaza.adjudicaciones.push(adjudicacion);
                
                this.reset();
                
                actualizarEstadisticas();
                actualizarSelectPlazas();
                renderizarTabla();
                
                const restantes = plaza.cantidadTotal - plaza.adjudicaciones.length;
                if (restantes > 0) {
                    alert(`‚úÖ Plaza adjudicada exitosamente\n\nQuedan ${restantes} vacante(s) disponible(s)`);
                } else {
                    alert('‚úÖ Plaza adjudicada exitosamente\n\nüéâ Esta plaza ha sido completamente ocupada');
                }
            }
        });

        function eliminarPlaza(index) {
            if (!isModerator) {
                alert('Debes estar en modo moderador para eliminar plazas');
                return;
            }
            
            if (confirm('¬øEst√° seguro de eliminar esta plaza?')) {
                plazas.splice(index, 1);
                actualizarEstadisticas();
                actualizarSelectPlazas();
                renderizarTabla();
            }
        }
    </script>
</body>
</html>